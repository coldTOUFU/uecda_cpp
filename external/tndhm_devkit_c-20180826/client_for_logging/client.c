#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "connection.h"
#include "daihinmin.h"

const int g_logging =
    0; //ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Û‚ï¿½ï¿½ð”»’è‚·ï¿½é‚½ï¿½ß‚Ì•Ïï¿½
FILE *g_read_fptr;
FILE *g_write_fptr;

int main(int argc, char *argv[]) {
  g_read_fptr = fopen("default_read.log", "a");
  if (g_read_fptr == NULL) {
    printf("cannot open file.\n");
    exit(1);
  }
  g_write_fptr = fopen("default_write.log", "a");
  if (g_write_fptr == NULL) {
    printf("cannot open file.\n");
    exit(1);
  }

  int my_playernum; //ï¿½vï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½[ï¿½Ôï¿½ï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
  int whole_gameend_flag =
      0; //ï¿½Sï¿½Qï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Û‚ï¿½ï¿½ð”»•Ê‚ï¿½ï¿½ï¿½Ïï¿½
  int one_gameend_flag =
      0; // 1ï¿½Qï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Û‚ï¿½ï¿½ð”»•Ê‚ï¿½ï¿½ï¿½Ïï¿½
  int accept_flag =
      0; //ï¿½ï¿½oï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½ó—‚ï¿½ï¿½ê‚½ï¿½ï¿½ï¿½ð”»•Ê‚ï¿½ï¿½ï¿½Ïï¿½
  int game_count = 0; //ï¿½Qï¿½[ï¿½ï¿½ï¿½Ì‰ñ”‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

  int own_cards_buf[8][15]; //ï¿½ï¿½Dï¿½ÌƒJï¿½[ï¿½hï¿½eï¿½[ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ß‚ï¿½Ïï¿½
  int own_cards[8][15]; //ï¿½ï¿½ï¿½ï¿½pï¿½ÌŽï¿½Dï¿½Ìƒeï¿½[ï¿½uï¿½ï¿½
  int ba_cards_buf[8][15]; //ï¿½ï¿½Éoï¿½ï¿½ï¿½Jï¿½[ï¿½hï¿½eï¿½[ï¿½uï¿½ï¿½ï¿½ï¿½[ï¿½ß‚ï¿½
  int ba_cards[8][15]; //ï¿½ï¿½ï¿½ï¿½pï¿½Ìï¿½ÌŽDï¿½Ìƒeï¿½[ï¿½uï¿½ï¿½

  //ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ`ï¿½Fï¿½bï¿½N ï¿½ï¿½ï¿½ï¿½ï¿½É]ï¿½ï¿½ï¿½ÄƒTï¿½[ï¿½oï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½Aï¿½Ú‘ï¿½ï¿½|ï¿½[ï¿½gï¿½Aï¿½Nï¿½ï¿½ï¿½Cï¿½Aï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ÏX
  checkArg(argc, argv);

  //ï¿½Qï¿½[ï¿½ï¿½ï¿½ÉŽQï¿½ï¿½
  my_playernum = entryToGame();

  while (whole_gameend_flag == 0) {
    one_gameend_flag = 0; // 1ï¿½Qï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

    game_count =
        startGame(own_cards_buf); //ï¿½ï¿½ï¿½Eï¿½ï¿½ï¿½hï¿½ï¿½ï¿½nï¿½ß‚ï¿½
                                  //ï¿½Åï¿½ï¿½ÌƒJï¿½[ï¿½hï¿½ï¿½ï¿½ó‚¯Žï¿½ï¿½B
    copyTable(own_cards,
              own_cards_buf); //ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½eï¿½[ï¿½uï¿½ï¿½ï¿½ð‘€ì‚·ï¿½é‚½ï¿½ß‚Ìƒeï¿½[ï¿½uï¿½ï¿½ï¿½ÉƒRï¿½sï¿½[
    ///ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½
    if (own_cards[5][0] == 0) { //ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½`ï¿½Fï¿½bï¿½N ==1ï¿½Åï¿½ï¿½ï¿½
      printf("not card-change turn?\n");
      exit(1);
    } else { //ï¿½eï¿½[ï¿½uï¿½ï¿½ï¿½É–ï¿½è‚ªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÎŽï¿½ï¿½Û‚ÉŒï¿½ï¿½ï¿½ï¿½ï¿½
      if (own_cards[5][1] > 0 && own_cards[5][1] < 100) {
        int change_qty = own_cards[5][1]; //ï¿½Jï¿½[ï¿½hï¿½ÌŒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        int select_cards[8][15] = {{0}}; //ï¿½Iï¿½ñ‚¾ƒJï¿½[ï¿½hï¿½ï¿½ï¿½iï¿½[

        //ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Aï¿½ï¿½xï¿½ï¿½ï¿½Å‚ï¿½ï¿½ï¿½Î•sï¿½vï¿½ÈƒJï¿½[ï¿½hï¿½ï¿½Iï¿½Ñoï¿½ï¿½

        /////////////////////////////////////////////////////////////
        //ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ÌƒAï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½Yï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½ï¿½Éï¿½ï¿½ï¿½
        /////////////////////////////////////////////////////////////

        change(select_cards, own_cards, change_qty);

        /////////////////////////////////////////////////////////////
        //ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ÌƒAï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½Yï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½
        /////////////////////////////////////////////////////////////

        //ï¿½Iï¿½ñ‚¾ƒJï¿½[ï¿½hï¿½ð‘—M
        sendChangingCards(select_cards);
      } else {
        //ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‰ï¿½ï¿½È‚ï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Kï¿½vï¿½Í‚È‚ï¿½
      }
    } //ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½

    while (one_gameend_flag == 0) { // 1ï¿½Qï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½Ü‚Å‚ÌŒJï¿½ï¿½Ô‚ï¿½
      int select_cards[8][15] = {{0}}; //ï¿½ï¿½oï¿½pï¿½Ìƒeï¿½[ï¿½uï¿½ï¿½

      if (receiveCards(own_cards_buf) ==
          1) { //ï¿½Jï¿½[ï¿½hï¿½ï¿½own_cards_bufï¿½ÉŽó‚¯Žï¿½ï¿½
               //ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚Ì“Ç‚Ýoï¿½ï¿½
               //ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ^ï¿½[ï¿½ï¿½ï¿½Å‚ï¿½ï¿½é‚©ï¿½ï¿½ï¿½mï¿½Fï¿½ï¿½ï¿½ï¿½
        //ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ^ï¿½[ï¿½ï¿½ï¿½Å‚ï¿½ï¿½ï¿½Î‚ï¿½ï¿½Ìƒuï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½B
        clearCards(select_cards); //ï¿½Iï¿½ñ‚¾ƒJï¿½[ï¿½hï¿½ÌƒNï¿½ï¿½ï¿½A
        copyTable(own_cards, own_cards_buf); //ï¿½Jï¿½[ï¿½hï¿½eï¿½[ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½sï¿½[
        /////////////////////////////////////////////////////////////
        //ï¿½Aï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½Yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        //ï¿½Ç‚ÌƒJï¿½[ï¿½hï¿½ï¿½ï¿½oï¿½ï¿½ï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½ï¿½É‚ï¿½ï¿½ï¿½
        /////////////////////////////////////////////////////////////
        if (state.onset == 1) { //ï¿½ï¿½ÉƒJï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½
          if (state.rev == 0) {
            lead(select_cards, own_cards); //ï¿½ÊíŽžï¿½Ì’ï¿½oï¿½p
          } else {
            leadRev(select_cards, own_cards); //ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½oï¿½p
          }
        } else { //ï¿½ï¿½ï¿½Å‚Éï¿½ÉƒJï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½
          if (state.rev == 0) {
            follow(select_cards, own_cards); //ï¿½ÊíŽžï¿½Ì’ï¿½oï¿½p
          } else {
            followRev(select_cards, own_cards); //ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½oï¿½p
          }
        }
        /////////////////////////////////////////////////////////////
        //ï¿½Aï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½Yï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½
        /////////////////////////////////////////////////////////////

        accept_flag = sendCards(select_cards); // cardsï¿½ï¿½ï¿½o
      } else {
        //ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ^ï¿½[ï¿½ï¿½ï¿½Å‚Í‚È‚ï¿½ï¿½ï¿½
        //ï¿½Kï¿½vï¿½È‚ç‚±ï¿½ï¿½ï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½qï¿½ï¿½ï¿½ï¿½
      }

      //ï¿½ï¿½ï¿½Ìƒ^ï¿½[ï¿½ï¿½ï¿½É’ï¿½oï¿½ï¿½ï¿½ê‚½ï¿½ï¿½ï¿½Ê‚Ìƒeï¿½[ï¿½uï¿½ï¿½ï¿½ó‚¯Žï¿½ï¿½,ï¿½ï¿½Éoï¿½ï¿½ï¿½Jï¿½[ï¿½hï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½
      lookField(ba_cards_buf);
      copyTable(ba_cards, ba_cards_buf);

      ///////////////////////////////////////////////////////////////
      //ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½oï¿½ï¿½ï¿½ê‚½ï¿½ï¿½ï¿½ï¿½ ï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½[ï¿½hï¿½ï¿½ï¿½oï¿½ï¿½ï¿½Oï¿½Ìï¿½ï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½ï¿½Éï¿½ï¿½ï¿½
      ///////////////////////////////////////////////////////////////

      ///////////////////////////////////////////////////////////////
      //ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½
      ///////////////////////////////////////////////////////////////

      //ï¿½ï¿½ï¿½ÌƒQï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Û‚ï¿½ï¿½Ì’Ê’mï¿½ï¿½ï¿½Tï¿½[ï¿½oï¿½ï¿½ï¿½ç‚¤ï¿½ï¿½ï¿½ï¿½B
      switch (beGameEnd()) {
      case 0: // 0ï¿½Ì‚Æ‚ï¿½ï¿½Qï¿½[ï¿½ï¿½ï¿½ð‘±‚ï¿½ï¿½ï¿½
        one_gameend_flag = 0;
        whole_gameend_flag = 0;
        break;
      case 1: // 1ï¿½Ì‚Æ‚ï¿½ 1ï¿½Qï¿½[ï¿½ï¿½ï¿½ÌIï¿½ï¿½
        one_gameend_flag = 1;
        whole_gameend_flag = 0;
        if (g_logging == 1) {
          printf("game #%d was finished.\n", game_count);
        }
        break;
      default: //ï¿½ï¿½ï¿½Ì‘ï¿½ï¿½Ìê‡ ï¿½Sï¿½Qï¿½[ï¿½ï¿½ï¿½ÌIï¿½ï¿½
        one_gameend_flag = 1;
        whole_gameend_flag = 1;
        if (g_logging == 1) {
          printf("All game was finished(Total %d games.)\n", game_count);
        }
        break;
      }
    } // 1ï¿½Qï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½Ü‚Å‚ÌŒJï¿½ï¿½Ô‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½
  } //ï¿½Sï¿½Qï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½Ü‚Å‚ÌŒJï¿½ï¿½Ô‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½
  //ï¿½\ï¿½Pï¿½bï¿½gï¿½ï¿½Â‚ï¿½ï¿½ÄIï¿½ï¿½
  if (closeSocket() != 0) {
    printf("failed to close socket\n");
    exit(1);
  }
  fclose(g_read_fptr);
  fclose(g_write_fptr);
  exit(0);
}
